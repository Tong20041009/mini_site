<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>2048</title>
<style>
  :root{ --bg:#0f1115; --board:#151922; --cell:#1d2430; --fg:#e6e6e6; --muted:#9aa3af; --pri:#6ea8ff;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui;display:flex;justify-content:center}
  .wrap{width:min(96vw,520px);padding:18px}
  h1{margin:6px 0 10px;font-size:22px}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .score{background:#1b2130;border:1px solid #2a3140;border-radius:12px;padding:8px 12px;min-width:110px;text-align:center}
  .btn{background:var(--pri);color:#000;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .board{margin-top:14px;background:var(--board);border:1px solid #232732;border-radius:14px;padding:10px;position:relative}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .cell,.tile{height:calc((min(96vw,520px)-18px - 2px - 10px*5)/4); /* 自适应方格高 */
              background:var(--cell);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px}
  .tile{position:absolute;inset:auto;transition:transform .12s ease; color:#0f1115}
  .label{font-size:12px;color:var(--muted)}
  .end{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;border-radius:12px;backdrop-filter:blur(2px);display:none}
  .panel{background:#121723;padding:18px 16px;border:1px solid #293042;border-radius:12px;text-align:center}
  .panel h2{margin:0 0 8px}
  @media (min-width:520px){ .cell,.tile{ height:100px; font-size:32px } }
  /* 颜色表 */
  .n2 {background:#e9edf9} .n4 {background:#d4e4ff}
  .n8 {background:#a7c8ff} .n16{background:#7fb2ff}
  .n32{background:#6ea8ff} .n64{background:#5b9bff}
  .n128{background:#ffd86e}.n256{background:#ffc84d}
  .n512{background:#ffb54d}.n1024{background:#ffa64d}
  .n2048{background:#ff8f4d;color:#111}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>2048</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="score"><div class="label">分数</div><div id="score">0</div></div>
      <div class="score"><div class="label">最高</div><div id="best">0</div></div>
      <button class="btn" id="new">新游戏</button>
    </div>
  </div>

  <div class="board" id="board" style="aspect-ratio:1/1">
    <!-- 背景网格 -->
    <div class="grid" id="grid">
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
      <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
    </div>
    <!-- 动态方块容器 -->
    <div id="tiles"></div>

    <div class="end" id="end">
      <div class="panel">
        <h2 id="endTitle">Game Over</h2>
        <p class="label">上滑/按↑继续挑战？</p >
        <button class="btn" id="again">再来一局</button>
      </div>
    </div>
  </div>

  <p class="label">操作：方向键 / 触屏滑动。合成到 2048！</p >
</div>

<script>
/* ===== 2048 核心逻辑（4x4） ===== */
const SIZE=4;
let grid, score=0, best=+localStorage.getItem('best2048')||0;
const tilesEl = document.getElementById('tiles');
const scoreEl = document.getElementById('score');
const bestEl  = document.getElementById('best');
const endEl   = document.getElementById('end');
const endTitle= document.getElementById('endTitle');
bestEl.textContent = best;

// 工具
const pos = (r,c)=>({r,c});
function emptyCells(){
  const a=[];
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++) if(!grid[r][c]) a.push(pos(r,c));
  return a;
}
function addRandom(){
  const cells = emptyCells();
  if(!cells.length) return false;
  const {r,c}=cells[Math.floor(Math.random()*cells.length)];
  grid[r][c] = Math.random()<0.9?2:4;
  spawnTile(r,c,grid[r][c]);
  return true;
}

// 视图：为每个值创建/移动 tile
function *allCells(){
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++) yield {r,c};
}
function clearTiles(){ tilesEl.innerHTML=''; }
function spawnTile(r,c,val){
  const t = document.createElement('div');
  t.className = `tile n${val}`;
  t.textContent = val;
  positionTile(t,r,c);
  tilesEl.appendChild(t);
}
function positionTile(el,r,c){
  const board = document.getElementById('grid');
  const cell = board.children[r*SIZE+c];
  const rectB = board.getBoundingClientRect();
  const rectC = cell.getBoundingClientRect();
  el.style.transform = `translate(${rectC.left-rectB.left}px, ${rectC.top-rectB.top}px)`;
  el.style.width = rectC.width+'px';
  el.style.height= rectC.height+'px';
}

// 渲染整个 grid
function render(){
  clearTiles();
  for(const {r,c} of allCells()){
    const v = grid[r][c];
    if(v) spawnTile(r,c,v);
  }
  scoreEl.textContent = score;
  if(score>best){ best=score; localStorage.setItem('best2048',best); bestEl.textContent=best; }
}

// 移动与合并
function line(arr){
  // 压缩非零
  const a = arr.filter(v=>v);
  for(let i=0;i<a.length-1;i++){
    if(a[i]===a[i+1]){ a[i]*=2; score+=a[i]; a[i+1]=0; i++; }
  }
  return a.filter(v=>v);
}
function move(dir){ // 'left' 'right' 'up' 'down'
  let moved=false;
  const before = JSON.stringify(grid);
  if(dir==='left' || dir==='right'){
    for(let r=0;r<SIZE;r++){
      let row = grid[r].slice();
      if(dir==='right') row.reverse();
      row = line(row);
      while(row.length<SIZE) row.push(0);
      if(dir==='right') row.reverse();
      grid[r]=row;
    }
  }else{
    for(let c=0;c<SIZE;c++){
      let col = grid.map(r=>r[c]);
      if(dir==='down') col.reverse();
      col = line(col);
      while(col.length<SIZE) col.push(0);
      if(dir==='down') col.reverse();
      for(let r=0;r<SIZE;r++) grid[r][c]=col[r];
    }
  }
  moved = before !== JSON.stringify(grid);
  if(moved){ addRandom(); render(); checkEnd(); }
  return moved;
}
function checkEnd(){
  if(emptyCells().length) return;
  // 检查是否还有可合并
  for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
    const v=grid[r][c];
    if(r+1<SIZE && grid[r+1][c]===v) return;
    if(c+1<SIZE && grid[r][c+1]===v) return;
  }
  endTitle.textContent='Game Over';
  endEl.style.display='flex';
}
function won(){
  for(const {r,c} of allCells()) if(grid[r][c]===2048) { endTitle.textContent='🎉 你赢了！'; endEl.style.display='flex'; return; }
}

// 初始化
function reset(){
  grid = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  score=0; endEl.style.display='none';
  addRandom(); addRandom(); render();
}
reset();

// 键盘
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(['arrowleft','a'].includes(k)) move('left');
  if(['arrowright','d'].includes(k)) move('right');
  if(['arrowup','w'].includes(k)) move('up');
  if(['arrowdown','s'].includes(k)) move('down');
  if(k==='r') reset();
  won();
});
document.getElementById('new').onclick=reset;
document.getElementById('again').onclick=reset;

// 触屏滑动
let sx=0, sy=0, moved=false;
const area=document.getElementById('board');
area.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; moved=false; },{passive:true});
area.addEventListener('touchmove',e=>{ moved=true; },{passive:true});
area.addEventListener('touchend',e=>{
  if(!moved) return;
  const dx=e.changedTouches[0].clientX - sx;
  const dy=e.changedTouches[0].clientY - sy;
  if(Math.abs(dx)>Math.abs(dy)){
    move(dx>0?'right':'left');
  }else{
    move(dy>0?'down':'up');
  }
  won();
});
addEventListener('resize',()=>requestAnimationFrame(render)); // 保持 tile 位置
</script>
</body>
</html>